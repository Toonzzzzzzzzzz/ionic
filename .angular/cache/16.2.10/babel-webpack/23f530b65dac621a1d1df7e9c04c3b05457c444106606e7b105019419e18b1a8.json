{"ast":null,"code":"import _asyncToGenerator from \"/home/toon/works/gitionic7/ionic-github/ionic/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nvar _class;\nimport { FormControl } from '@angular/forms';\nimport { CoreError } from '@classes/errors/error';\nimport { CoreFileUploader } from '@features/fileuploader/services/fileuploader';\nimport { CoreFile } from '@services/file';\nimport { CoreFileHelper } from '@services/file-helper';\nimport { CoreFileSession } from '@services/file-session';\nimport { CoreSites } from '@services/sites';\nimport { CoreSync } from '@services/sync';\nimport { CoreDomUtils } from '@services/utils/dom';\nimport { CoreTextUtils } from '@services/utils/text';\nimport { CoreUtils } from '@services/utils/utils';\nimport { Translate } from '@singletons';\nimport { CoreEvents } from '@singletons/events';\nimport { CoreForms } from '@singletons/form';\nimport { AddonWorkshopAssessmentStrategyDelegate } from '../../services/assessment-strategy-delegate';\nimport { AddonModWorkshopProvider, AddonModWorkshopOverallFeedbackMode, AddonModWorkshop } from '../../services/workshop';\nimport { AddonModWorkshopHelper } from '../../services/workshop-helper';\nimport { AddonModWorkshopOffline } from '../../services/workshop-offline';\nimport { ADDON_MOD_WORKSHOP_COMPONENT } from '@addons/mod/workshop/constants';\nimport * as i0 from \"@angular/core\";\nconst _c0 = [\"assessmentForm\"];\nfunction AddonModWorkshopAssessmentStrategyComponent_ng_container_6_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementContainerStart(0);\n    i0.ɵɵelement(1, \"core-dynamic-component\", 6);\n    i0.ɵɵelementContainerEnd();\n  }\n  if (rf & 2) {\n    const ctx_r1 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"component\", ctx_r1.componentClass)(\"data\", ctx_r1.data);\n  }\n}\nconst _c1 = function (a0) {\n  return {\n    $a: a0\n  };\n};\nfunction AddonModWorkshopAssessmentStrategyComponent_ion_card_7_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"ion-card\", 7)(1, \"ion-item\")(2, \"ion-label\")(3, \"p\");\n    i0.ɵɵtext(4);\n    i0.ɵɵpipe(5, \"translate\");\n    i0.ɵɵelementEnd()()()();\n  }\n  if (rf & 2) {\n    const ctx_r2 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate(i0.ɵɵpipeBind2(5, 1, \"addon.mod_workshop.assessmentstrategynotsupported\", i0.ɵɵpureFunction1(4, _c1, ctx_r2.strategy)));\n  }\n}\nfunction AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_6_core_input_errors_6_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelement(0, \"core-input-errors\", 17);\n  }\n  if (rf & 2) {\n    const ctx_r9 = i0.ɵɵnextContext(3);\n    i0.ɵɵproperty(\"errorText\", ctx_r9.data.fieldErrors[\"feedbackauthor\"]);\n  }\n}\nconst _c2 = function (a0) {\n  return {\n    asid: a0\n  };\n};\nfunction AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_6_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r11 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"ion-item\", 13)(1, \"ion-label\", 13)(2, \"span\", 14);\n    i0.ɵɵtext(3);\n    i0.ɵɵpipe(4, \"translate\");\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(5, \"core-rich-text-editor\", 15);\n    i0.ɵɵlistener(\"contentChanged\", function AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_6_Template_core_rich_text_editor_contentChanged_5_listener($event) {\n      i0.ɵɵrestoreView(_r11);\n      const ctx_r10 = i0.ɵɵnextContext(2);\n      return i0.ɵɵresetView(ctx_r10.onFeedbackChange($event));\n    });\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(6, AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_6_core_input_errors_6_Template, 1, 1, \"core-input-errors\", 16);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r4 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"core-mark-required\", ctx_r4.overallFeedkbackRequired);\n    i0.ɵɵadvance(1);\n    i0.ɵɵtextInterpolate1(\" \", i0.ɵɵpipeBind1(4, 9, \"addon.mod_workshop.feedbackauthor\"), \" \");\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"control\", ctx_r4.feedbackControl)(\"component\", ctx_r4.component)(\"componentId\", ctx_r4.workshop.coursemodule)(\"autoSave\", true)(\"contextInstanceId\", ctx_r4.workshop.coursemodule)(\"draftExtraParams\", i0.ɵɵpureFunction1(11, _c2, ctx_r4.assessmentId));\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngIf\", ctx_r4.overallFeedkbackRequired && ctx_r4.data.fieldErrors && ctx_r4.data.fieldErrors[\"feedbackauthor\"]);\n  }\n}\nfunction AddonModWorkshopAssessmentStrategyComponent_ion_card_8_core_attachments_7_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelement(0, \"core-attachments\", 18);\n  }\n  if (rf & 2) {\n    const ctx_r5 = i0.ɵɵnextContext(2);\n    i0.ɵɵproperty(\"files\", ctx_r5.data.assessment == null ? null : ctx_r5.data.assessment.feedbackattachmentfiles)(\"maxSize\", ctx_r5.workshop.overallfeedbackmaxbytes)(\"maxSubmissions\", ctx_r5.workshop.overallfeedbackfiles)(\"component\", ctx_r5.component)(\"componentId\", ctx_r5.componentId)(\"allowOffline\", true)(\"courseId\", ctx_r5.workshop.course);\n  }\n}\nfunction AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_8_ion_select_option_8_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"ion-select-option\", 21);\n    i0.ɵɵtext(1);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const w_r13 = ctx.$implicit;\n    i0.ɵɵproperty(\"value\", w_r13);\n    i0.ɵɵadvance(1);\n    i0.ɵɵtextInterpolate(w_r13);\n  }\n}\nconst _c3 = function (a0) {\n  return {\n    header: a0\n  };\n};\nfunction AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_8_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r15 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"ion-item\")(1, \"ion-label\", 13)(2, \"span\", 14);\n    i0.ɵɵtext(3);\n    i0.ɵɵpipe(4, \"translate\");\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(5, \"ion-select\", 19);\n    i0.ɵɵlistener(\"ngModelChange\", function AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_8_Template_ion_select_ngModelChange_5_listener($event) {\n      i0.ɵɵrestoreView(_r15);\n      const ctx_r14 = i0.ɵɵnextContext(2);\n      return i0.ɵɵresetView(ctx_r14.weight = $event);\n    });\n    i0.ɵɵpipe(6, \"translate\");\n    i0.ɵɵpipe(7, \"translate\");\n    i0.ɵɵtemplate(8, AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_8_ion_select_option_8_Template, 2, 2, \"ion-select-option\", 20);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const ctx_r6 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"core-mark-required\", true);\n    i0.ɵɵadvance(1);\n    i0.ɵɵtextInterpolate1(\" \", i0.ɵɵpipeBind1(4, 6, \"addon.mod_workshop.assessmentweight\"), \" \");\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"ngModel\", ctx_r6.weight)(\"cancelText\", i0.ɵɵpipeBind1(6, 8, \"core.cancel\"))(\"interfaceOptions\", i0.ɵɵpureFunction1(12, _c3, i0.ɵɵpipeBind1(7, 10, \"addon.mod_workshop.assessmentweight\")));\n    i0.ɵɵadvance(3);\n    i0.ɵɵproperty(\"ngForOf\", ctx_r6.weights);\n  }\n}\nfunction AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_9_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"ion-item\", 8)(1, \"ion-label\");\n    i0.ɵɵelement(2, \"core-format-text\", 22);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const ctx_r7 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"component\", ctx_r7.component)(\"componentId\", ctx_r7.componentId)(\"text\", ctx_r7.data.assessment == null ? null : ctx_r7.data.assessment.feedbackauthor)(\"contextInstanceId\", ctx_r7.workshop.coursemodule)(\"courseId\", ctx_r7.workshop.course);\n  }\n}\nfunction AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_10_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"ion-item\")(1, \"ion-label\");\n    i0.ɵɵelement(2, \"core-files\", 23);\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const ctx_r8 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"files\", ctx_r8.data.assessment == null ? null : ctx_r8.data.assessment.feedbackattachmentfiles)(\"component\", ctx_r8.component)(\"componentId\", ctx_r8.componentId);\n  }\n}\nfunction AddonModWorkshopAssessmentStrategyComponent_ion_card_8_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"ion-card\")(1, \"ion-item\", 8)(2, \"ion-label\")(3, \"h3\", 9);\n    i0.ɵɵtext(4);\n    i0.ɵɵpipe(5, \"translate\");\n    i0.ɵɵelementEnd()()();\n    i0.ɵɵtemplate(6, AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_6_Template, 7, 13, \"ion-item\", 10);\n    i0.ɵɵtemplate(7, AddonModWorkshopAssessmentStrategyComponent_ion_card_8_core_attachments_7_Template, 1, 7, \"core-attachments\", 11);\n    i0.ɵɵtemplate(8, AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_8_Template, 9, 14, \"ion-item\", 4);\n    i0.ɵɵtemplate(9, AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_9_Template, 3, 5, \"ion-item\", 12);\n    i0.ɵɵtemplate(10, AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_10_Template, 3, 3, \"ion-item\", 4);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r3 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate(i0.ɵɵpipeBind1(5, 6, \"addon.mod_workshop.overallfeedback\"));\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"ngIf\", ctx_r3.edit);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngIf\", ctx_r3.edit && ctx_r3.workshop.overallfeedbackfiles);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngIf\", ctx_r3.edit && ctx_r3.access && ctx_r3.access.canallocate);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngIf\", !ctx_r3.edit && (ctx_r3.data.assessment == null ? null : ctx_r3.data.assessment.feedbackauthor));\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngIf\", !ctx_r3.edit && ctx_r3.workshop.overallfeedbackfiles && (ctx_r3.data.assessment == null ? null : ctx_r3.data.assessment.feedbackattachmentfiles == null ? null : ctx_r3.data.assessment.feedbackattachmentfiles.length));\n  }\n}\n/**\n * Component that displays workshop assessment strategy form.\n */\nexport class AddonModWorkshopAssessmentStrategyComponent {\n  constructor() {\n    this.edit = false;\n    this.data = {\n      workshopId: 0,\n      assessment: undefined,\n      edit: false,\n      selectedValues: [],\n      fieldErrors: {},\n      strategy: '',\n      moduleId: 0,\n      courseId: undefined\n    };\n    this.assessmentStrategyLoaded = false;\n    this.notSupported = false;\n    this.feedbackText = '';\n    this.feedbackControl = new FormControl();\n    this.overallFeedkback = false;\n    this.overallFeedkbackRequired = false;\n    this.component = ADDON_MOD_WORKSHOP_COMPONENT;\n    this.weights = [];\n    this.hasOffline = false;\n    this.originalData = {\n      text: '',\n      files: [],\n      weight: 1,\n      selectedValues: []\n    };\n  }\n  /**\n   * @inheritdoc\n   */\n  ngOnInit() {\n    var _this = this;\n    return _asyncToGenerator(function* () {\n      if (!_this.assessmentId || !_this.strategy) {\n        _this.assessmentStrategyLoaded = true;\n        return;\n      }\n      _this.data.workshopId = _this.workshop.id;\n      _this.data.edit = _this.edit;\n      _this.data.strategy = _this.strategy;\n      _this.data.moduleId = _this.workshop.coursemodule;\n      _this.data.courseId = _this.workshop.course;\n      _this.componentClass = yield AddonWorkshopAssessmentStrategyDelegate.getComponentForPlugin(_this.strategy);\n      if (_this.componentClass) {\n        _this.overallFeedkback = _this.workshop.overallfeedbackmode != AddonModWorkshopOverallFeedbackMode.DISABLED;\n        _this.overallFeedkbackRequired = _this.workshop.overallfeedbackmode == AddonModWorkshopOverallFeedbackMode.ENABLED_REQUIRED;\n        _this.componentId = _this.workshop.coursemodule;\n        // Load Weights selector.\n        if (_this.edit && _this.access.canallocate) {\n          _this.weights = [];\n          for (let i = 16; i >= 0; i--) {\n            _this.weights[i] = i;\n          }\n        }\n        // Check if rich text editor is enabled.\n        if (_this.edit) {\n          // Block the workshop.\n          CoreSync.blockOperation(ADDON_MOD_WORKSHOP_COMPONENT, _this.workshop.id);\n        }\n        try {\n          yield _this.load();\n          _this.obsInvalidated = CoreEvents.on(AddonModWorkshopProvider.ASSESSMENT_INVALIDATED, () => _this.load(), CoreSites.getCurrentSiteId());\n        } catch (error) {\n          _this.componentClass = undefined;\n          CoreDomUtils.showErrorModalDefault(error, 'Error loading assessment.');\n        } finally {\n          _this.assessmentStrategyLoaded = true;\n        }\n      } else {\n        // Helper data and fallback.\n        _this.notSupported = !AddonWorkshopAssessmentStrategyDelegate.isPluginSupported(_this.strategy);\n        _this.assessmentStrategyLoaded = true;\n      }\n    })();\n  }\n  /**\n   * Convenience function to load the assessment data.\n   *\n   * @returns Promised resvoled when data is loaded.\n   */\n  load() {\n    var _this2 = this;\n    return _asyncToGenerator(function* () {\n      _this2.data.assessment = yield AddonModWorkshopHelper.getReviewerAssessmentById(_this2.workshop.id, _this2.assessmentId, {\n        userId: _this2.userId,\n        cmId: _this2.workshop.coursemodule\n      });\n      if (!_this2.data.assessment.form) {\n        return;\n      }\n      if (_this2.edit) {\n        try {\n          const offlineAssessment = yield AddonModWorkshopOffline.getAssessment(_this2.workshop.id, _this2.assessmentId);\n          const offlineData = offlineAssessment.inputdata;\n          _this2.hasOffline = true;\n          _this2.data.assessment.feedbackauthor = offlineData.feedbackauthor;\n          if (_this2.access.canallocate) {\n            _this2.data.assessment.weight = offlineData.weight;\n          }\n          // Override assessment plugins values.\n          _this2.data.assessment.form.current = AddonModWorkshop.parseFields(CoreUtils.objectToArrayOfObjects(offlineData, 'name', 'value'));\n          // Override offline files.\n          if (offlineData) {\n            _this2.data.assessment.feedbackattachmentfiles = yield AddonModWorkshopHelper.getAssessmentFilesFromOfflineFilesObject(offlineData.feedbackauthorattachmentsid, _this2.workshop.id, _this2.assessmentId);\n          }\n        } catch (_unused) {\n          _this2.hasOffline = false;\n          // Ignore errors.\n        } finally {\n          _this2.feedbackText = _this2.data.assessment.feedbackauthor;\n          _this2.feedbackControl.setValue(_this2.feedbackText);\n          _this2.originalData.text = _this2.data.assessment.feedbackauthor;\n          if (_this2.access.canallocate) {\n            _this2.originalData.weight = _this2.data.assessment.weight;\n          }\n          _this2.originalData.files = [];\n          _this2.data.assessment.feedbackattachmentfiles.forEach(file => {\n            let filename = CoreFile.getFileName(file);\n            if (!filename) {\n              // We don't have filename, extract it from the path.\n              filename = CoreFileHelper.getFilenameFromPath(file) || '';\n            }\n            _this2.originalData.files.push({\n              filename,\n              fileurl: '' // No needed to compare.\n            });\n          });\n        }\n      }\n\n      try {\n        _this2.data.selectedValues = yield AddonWorkshopAssessmentStrategyDelegate.getOriginalValues(_this2.strategy, _this2.data.assessment.form, _this2.workshop.id);\n      } finally {\n        _this2.originalData.selectedValues = CoreUtils.clone(_this2.data.selectedValues);\n        if (_this2.edit) {\n          CoreFileSession.setFiles(ADDON_MOD_WORKSHOP_COMPONENT, _this2.workshop.id + '_' + _this2.assessmentId, _this2.data.assessment.feedbackattachmentfiles);\n          if (_this2.access.canallocate) {\n            _this2.weight = _this2.data.assessment.weight;\n          }\n        }\n      }\n    })();\n  }\n  /**\n   * Check if data has changed.\n   *\n   * @returns True if data has changed.\n   */\n  hasDataChanged() {\n    var _this$data$assessment;\n    if (!this.assessmentStrategyLoaded || !this.workshop.strategy) {\n      return false;\n    }\n    // Compare feedback text.\n    const text = CoreTextUtils.restorePluginfileUrls(this.feedbackText, ((_this$data$assessment = this.data.assessment) === null || _this$data$assessment === void 0 ? void 0 : _this$data$assessment.feedbackcontentfiles) || []);\n    if (this.originalData.text != text) {\n      return true;\n    }\n    if (this.access.canallocate && this.originalData.weight != this.weight) {\n      return true;\n    }\n    // Compare feedback files.\n    const files = CoreFileSession.getFiles(ADDON_MOD_WORKSHOP_COMPONENT, this.workshop.id + '_' + this.assessmentId) || [];\n    if (CoreFileUploader.areFileListDifferent(files, this.originalData.files)) {\n      return true;\n    }\n    return AddonWorkshopAssessmentStrategyDelegate.hasDataChanged(this.workshop.strategy, this.originalData.selectedValues, this.data.selectedValues);\n  }\n  /**\n   * Save the assessment.\n   *\n   * @returns Promise resolved when done, rejected if assessment could not be saved.\n   */\n  saveAssessment() {\n    var _this3 = this;\n    return _asyncToGenerator(function* () {\n      var _this3$data$assessmen;\n      if (!((_this3$data$assessmen = _this3.data.assessment) !== null && _this3$data$assessmen !== void 0 && _this3$data$assessmen.form)) {\n        return;\n      }\n      const files = CoreFileSession.getFiles(ADDON_MOD_WORKSHOP_COMPONENT, _this3.workshop.id + '_' + _this3.assessmentId) || [];\n      let saveOffline = false;\n      let allowOffline = !files.length;\n      const modal = yield CoreDomUtils.showModalLoading('core.sending', true);\n      _this3.data.fieldErrors = {};\n      try {\n        var _this3$data$assessmen2;\n        let attachmentsId;\n        try {\n          // Upload attachments first if any.\n          attachmentsId = yield AddonModWorkshopHelper.uploadOrStoreAssessmentFiles(_this3.workshop.id, _this3.assessmentId, files, saveOffline);\n        } catch (error) {\n          if (CoreUtils.isWebServiceError(error)) {\n            throw error;\n          }\n          // Cannot upload them in online, save them in offline.\n          saveOffline = true;\n          allowOffline = true;\n          attachmentsId = yield AddonModWorkshopHelper.uploadOrStoreAssessmentFiles(_this3.workshop.id, _this3.assessmentId, files, saveOffline);\n        }\n        const text = CoreTextUtils.restorePluginfileUrls(_this3.feedbackText, ((_this3$data$assessmen2 = _this3.data.assessment) === null || _this3$data$assessmen2 === void 0 ? void 0 : _this3$data$assessmen2.feedbackcontentfiles) || []);\n        let assessmentData;\n        try {\n          assessmentData = yield AddonModWorkshopHelper.prepareAssessmentData(_this3.workshop, _this3.data.selectedValues, text, _this3.data.assessment.form, attachmentsId);\n        } catch (errors) {\n          _this3.data.fieldErrors = errors;\n          throw new CoreError(Translate.instant('core.errorinvalidform'));\n        }\n        let gradeUpdated = false;\n        if (saveOffline) {\n          // Save assessment in offline.\n          yield AddonModWorkshopOffline.saveAssessment(_this3.workshop.id, _this3.assessmentId, _this3.workshop.course, assessmentData);\n        } else {\n          // Try to send it to server.\n          // Don't allow offline if there are attachments since they were uploaded fine.\n          gradeUpdated = yield AddonModWorkshop.updateAssessment(_this3.workshop.id, _this3.assessmentId, _this3.workshop.course, assessmentData, undefined, allowOffline);\n        }\n        CoreForms.triggerFormSubmittedEvent(_this3.formElement, !!gradeUpdated, CoreSites.getCurrentSiteId());\n        const promises = [];\n        // If sent to the server, invalidate and clean.\n        if (gradeUpdated) {\n          promises.push(AddonModWorkshopHelper.deleteAssessmentStoredFiles(_this3.workshop.id, _this3.assessmentId));\n          promises.push(AddonModWorkshop.invalidateAssessmentFormData(_this3.workshop.id, _this3.assessmentId));\n          promises.push(AddonModWorkshop.invalidateAssessmentData(_this3.workshop.id, _this3.assessmentId));\n        }\n        yield CoreUtils.ignoreErrors(Promise.all(promises));\n        CoreEvents.trigger(AddonModWorkshopProvider.ASSESSMENT_SAVED, {\n          workshopId: _this3.workshop.id,\n          assessmentId: _this3.assessmentId,\n          userId: CoreSites.getCurrentSiteUserId()\n        }, CoreSites.getCurrentSiteId());\n        if (files) {\n          // Delete the local files from the tmp folder.\n          CoreFileUploader.clearTmpFiles(files);\n        }\n      } catch (error) {\n        CoreDomUtils.showErrorModalDefault(error, 'Error saving assessment.');\n      } finally {\n        modal.dismiss();\n      }\n    })();\n  }\n  /**\n   * Feedback text changed.\n   *\n   * @param text The new text.\n   */\n  onFeedbackChange(text) {\n    this.feedbackText = text !== null && text !== void 0 ? text : '';\n  }\n  /**\n   * Component destroyed.\n   */\n  ngOnDestroy() {\n    var _this$obsInvalidated, _this$data$assessment2;\n    (_this$obsInvalidated = this.obsInvalidated) === null || _this$obsInvalidated === void 0 || _this$obsInvalidated.off();\n    if ((_this$data$assessment2 = this.data.assessment) !== null && _this$data$assessment2 !== void 0 && _this$data$assessment2.feedbackattachmentfiles) {\n      // Delete the local files from the tmp folder.\n      CoreFileUploader.clearTmpFiles(this.data.assessment.feedbackattachmentfiles);\n    }\n  }\n}\n_class = AddonModWorkshopAssessmentStrategyComponent;\n_class.ɵfac = function AddonModWorkshopAssessmentStrategyComponent_Factory(t) {\n  return new (t || _class)();\n};\n_class.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n  type: _class,\n  selectors: [[\"addon-mod-workshop-assessment-strategy\"]],\n  viewQuery: function AddonModWorkshopAssessmentStrategyComponent_Query(rf, ctx) {\n    if (rf & 1) {\n      i0.ɵɵviewQuery(_c0, 5);\n    }\n    if (rf & 2) {\n      let _t;\n      i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.formElement = _t.first);\n    }\n  },\n  inputs: {\n    workshop: \"workshop\",\n    access: \"access\",\n    assessmentId: \"assessmentId\",\n    userId: \"userId\",\n    strategy: \"strategy\",\n    edit: \"edit\"\n  },\n  decls: 9,\n  vars: 7,\n  consts: [[1, \"ion-padding\"], [\"name\", \"mma-mod_workshop-assessment-form\"], [\"assessmentForm\", \"\"], [3, \"hideUntil\"], [4, \"ngIf\"], [\"class\", \"core-info-card\", 4, \"ngIf\"], [3, \"component\", \"data\"], [1, \"core-info-card\"], [1, \"ion-text-wrap\"], [1, \"item-heading\"], [\"position\", \"stacked\", 4, \"ngIf\"], [3, \"files\", \"maxSize\", \"maxSubmissions\", \"component\", \"componentId\", \"allowOffline\", \"courseId\", 4, \"ngIf\"], [\"class\", \"ion-text-wrap\", 4, \"ngIf\"], [\"position\", \"stacked\"], [3, \"core-mark-required\"], [\"contextLevel\", \"module\", \"elementId\", \"feedbackauthor_editor\", 3, \"control\", \"component\", \"componentId\", \"autoSave\", \"contextInstanceId\", \"draftExtraParams\", \"contentChanged\"], [3, \"errorText\", 4, \"ngIf\"], [3, \"errorText\"], [3, \"files\", \"maxSize\", \"maxSubmissions\", \"component\", \"componentId\", \"allowOffline\", \"courseId\"], [\"interface\", \"action-sheet\", \"name\", \"weight\", 3, \"ngModel\", \"cancelText\", \"interfaceOptions\", \"ngModelChange\"], [3, \"value\", 4, \"ngFor\", \"ngForOf\"], [3, \"value\"], [\"contextLevel\", \"module\", 3, \"component\", \"componentId\", \"text\", \"contextInstanceId\", \"courseId\"], [3, \"files\", \"component\", \"componentId\"]],\n  template: function AddonModWorkshopAssessmentStrategyComponent_Template(rf, ctx) {\n    if (rf & 1) {\n      i0.ɵɵelementStart(0, \"h2\", 0);\n      i0.ɵɵtext(1);\n      i0.ɵɵpipe(2, \"translate\");\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementStart(3, \"form\", 1, 2)(5, \"core-loading\", 3);\n      i0.ɵɵtemplate(6, AddonModWorkshopAssessmentStrategyComponent_ng_container_6_Template, 2, 2, \"ng-container\", 4);\n      i0.ɵɵtemplate(7, AddonModWorkshopAssessmentStrategyComponent_ion_card_7_Template, 6, 6, \"ion-card\", 5);\n      i0.ɵɵtemplate(8, AddonModWorkshopAssessmentStrategyComponent_ion_card_8_Template, 11, 8, \"ion-card\", 4);\n      i0.ɵɵelementEnd()();\n    }\n    if (rf & 2) {\n      i0.ɵɵadvance(1);\n      i0.ɵɵtextInterpolate(i0.ɵɵpipeBind1(2, 5, \"addon.mod_workshop.assessmentform\"));\n      i0.ɵɵadvance(4);\n      i0.ɵɵproperty(\"hideUntil\", ctx.assessmentStrategyLoaded);\n      i0.ɵɵadvance(1);\n      i0.ɵɵproperty(\"ngIf\", ctx.componentClass && ctx.assessmentStrategyLoaded);\n      i0.ɵɵadvance(1);\n      i0.ɵɵproperty(\"ngIf\", ctx.notSupported);\n      i0.ɵɵadvance(1);\n      i0.ɵɵproperty(\"ngIf\", ctx.assessmentStrategyLoaded && ctx.overallFeedkback && (ctx.edit || (ctx.data.assessment == null ? null : ctx.data.assessment.feedbackauthor) || (ctx.data.assessment == null ? null : ctx.data.assessment.feedbackattachmentfiles == null ? null : ctx.data.assessment.feedbackattachmentfiles.length)));\n    }\n  },\n  encapsulation: 2\n});","map":{"version":3,"names":["FormControl","CoreError","CoreFileUploader","CoreFile","CoreFileHelper","CoreFileSession","CoreSites","CoreSync","CoreDomUtils","CoreTextUtils","CoreUtils","Translate","CoreEvents","CoreForms","AddonWorkshopAssessmentStrategyDelegate","AddonModWorkshopProvider","AddonModWorkshopOverallFeedbackMode","AddonModWorkshop","AddonModWorkshopHelper","AddonModWorkshopOffline","ADDON_MOD_WORKSHOP_COMPONENT","i0","ɵɵelementContainerStart","ɵɵelement","ɵɵelementContainerEnd","ɵɵadvance","ɵɵproperty","ctx_r1","componentClass","data","ɵɵelementStart","ɵɵtext","ɵɵelementEnd","ɵɵtextInterpolate","ɵɵpipeBind2","ɵɵpureFunction1","_c1","ctx_r2","strategy","ctx_r9","fieldErrors","ɵɵlistener","AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_6_Template_core_rich_text_editor_contentChanged_5_listener","$event","ɵɵrestoreView","_r11","ctx_r10","ɵɵnextContext","ɵɵresetView","onFeedbackChange","ɵɵtemplate","AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_6_core_input_errors_6_Template","ctx_r4","overallFeedkbackRequired","ɵɵtextInterpolate1","ɵɵpipeBind1","feedbackControl","component","workshop","coursemodule","_c2","assessmentId","ctx_r5","assessment","feedbackattachmentfiles","overallfeedbackmaxbytes","overallfeedbackfiles","componentId","course","w_r13","AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_8_Template_ion_select_ngModelChange_5_listener","_r15","ctx_r14","weight","AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_8_ion_select_option_8_Template","ctx_r6","_c3","weights","ctx_r7","feedbackauthor","ctx_r8","AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_6_Template","AddonModWorkshopAssessmentStrategyComponent_ion_card_8_core_attachments_7_Template","AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_8_Template","AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_9_Template","AddonModWorkshopAssessmentStrategyComponent_ion_card_8_ion_item_10_Template","ctx_r3","edit","access","canallocate","length","AddonModWorkshopAssessmentStrategyComponent","constructor","workshopId","undefined","selectedValues","moduleId","courseId","assessmentStrategyLoaded","notSupported","feedbackText","overallFeedkback","hasOffline","originalData","text","files","ngOnInit","_this","_asyncToGenerator","id","getComponentForPlugin","overallfeedbackmode","DISABLED","ENABLED_REQUIRED","i","blockOperation","load","obsInvalidated","on","ASSESSMENT_INVALIDATED","getCurrentSiteId","error","showErrorModalDefault","isPluginSupported","_this2","getReviewerAssessmentById","userId","cmId","form","offlineAssessment","getAssessment","offlineData","inputdata","current","parseFields","objectToArrayOfObjects","getAssessmentFilesFromOfflineFilesObject","feedbackauthorattachmentsid","_unused","setValue","forEach","file","filename","getFileName","getFilenameFromPath","push","fileurl","getOriginalValues","clone","setFiles","hasDataChanged","_this$data$assessment","restorePluginfileUrls","feedbackcontentfiles","getFiles","areFileListDifferent","saveAssessment","_this3","_this3$data$assessmen","saveOffline","allowOffline","modal","showModalLoading","_this3$data$assessmen2","attachmentsId","uploadOrStoreAssessmentFiles","isWebServiceError","assessmentData","prepareAssessmentData","errors","instant","gradeUpdated","updateAssessment","triggerFormSubmittedEvent","formElement","promises","deleteAssessmentStoredFiles","invalidateAssessmentFormData","invalidateAssessmentData","ignoreErrors","Promise","all","trigger","ASSESSMENT_SAVED","getCurrentSiteUserId","clearTmpFiles","dismiss","ngOnDestroy","_this$obsInvalidated","_this$data$assessment2","off","selectors","viewQuery","AddonModWorkshopAssessmentStrategyComponent_Query","rf","ctx","AddonModWorkshopAssessmentStrategyComponent_ng_container_6_Template","AddonModWorkshopAssessmentStrategyComponent_ion_card_7_Template","AddonModWorkshopAssessmentStrategyComponent_ion_card_8_Template"],"sources":["/home/toon/works/gitionic7/ionic-github/ionic/src/addons/mod/workshop/components/assessment-strategy/assessment-strategy.ts","/home/toon/works/gitionic7/ionic-github/ionic/src/addons/mod/workshop/components/assessment-strategy/addon-mod-workshop-assessment-strategy.html"],"sourcesContent":["// (C) Copyright 2015 Moodle Pty Ltd.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport { Component, Input, OnInit, ViewChild, ElementRef, Type, OnDestroy } from '@angular/core';\nimport { FormControl } from '@angular/forms';\nimport { CoreError } from '@classes/errors/error';\nimport { CoreFileUploader, CoreFileUploaderStoreFilesResult } from '@features/fileuploader/services/fileuploader';\nimport { CoreFile } from '@services/file';\nimport { CoreFileEntry, CoreFileHelper } from '@services/file-helper';\nimport { CoreFileSession } from '@services/file-session';\nimport { CoreSites } from '@services/sites';\nimport { CoreSync } from '@services/sync';\nimport { CoreDomUtils } from '@services/utils/dom';\nimport { CoreTextUtils } from '@services/utils/text';\nimport { CoreUtils } from '@services/utils/utils';\nimport { Translate } from '@singletons';\nimport { CoreEventObserver, CoreEvents } from '@singletons/events';\nimport { CoreFormFields, CoreForms } from '@singletons/form';\nimport { AddonWorkshopAssessmentStrategyDelegate } from '../../services/assessment-strategy-delegate';\nimport {\n    AddonModWorkshopProvider,\n    AddonModWorkshopOverallFeedbackMode,\n    AddonModWorkshop,\n    AddonModWorkshopData,\n    AddonModWorkshopGetWorkshopAccessInformationWSResponse,\n    AddonModWorkshopGetAssessmentFormFieldsParsedData,\n} from '../../services/workshop';\nimport { AddonModWorkshopHelper, AddonModWorkshopSubmissionAssessmentWithFormData } from '../../services/workshop-helper';\nimport { AddonModWorkshopOffline } from '../../services/workshop-offline';\nimport { ADDON_MOD_WORKSHOP_COMPONENT } from '@addons/mod/workshop/constants';\n\n/**\n * Component that displays workshop assessment strategy form.\n */\n@Component({\n    selector: 'addon-mod-workshop-assessment-strategy',\n    templateUrl: 'addon-mod-workshop-assessment-strategy.html',\n})\nexport class AddonModWorkshopAssessmentStrategyComponent implements OnInit, OnDestroy {\n\n    @Input() workshop!: AddonModWorkshopData;\n    @Input() access!: AddonModWorkshopGetWorkshopAccessInformationWSResponse;\n    @Input() assessmentId!: number;\n    @Input() userId!: number;\n    @Input() strategy!: string;\n    @Input() edit = false;\n\n    @ViewChild('assessmentForm') formElement!: ElementRef;\n\n    componentClass?: Type<unknown>;\n    data: AddonModWorkshopAssessmentStrategyData = {\n        workshopId: 0,\n        assessment: undefined,\n        edit: false,\n        selectedValues: [],\n        fieldErrors: {},\n        strategy: '',\n        moduleId: 0,\n        courseId: undefined,\n    };\n\n    assessmentStrategyLoaded = false;\n    notSupported = false;\n    feedbackText = '';\n    feedbackControl = new FormControl();\n    overallFeedkback = false;\n    overallFeedkbackRequired = false;\n    component = ADDON_MOD_WORKSHOP_COMPONENT;\n    componentId?: number;\n    weights: number[] = [];\n    weight?: number;\n\n    protected obsInvalidated?: CoreEventObserver;\n    protected hasOffline = false;\n    protected originalData: {\n        text: string;\n        files: CoreFileEntry[];\n        weight: number;\n        selectedValues: AddonModWorkshopGetAssessmentFormFieldsParsedData[];\n    } = {\n        text: '',\n        files: [],\n        weight: 1,\n        selectedValues: [],\n    };\n\n    /**\n     * @inheritdoc\n     */\n    async ngOnInit(): Promise<void> {\n        if (!this.assessmentId || !this.strategy) {\n            this.assessmentStrategyLoaded = true;\n\n            return;\n        }\n\n        this.data.workshopId = this.workshop.id;\n        this.data.edit = this.edit;\n        this.data.strategy = this.strategy;\n        this.data.moduleId = this.workshop.coursemodule;\n        this.data.courseId = this.workshop.course;\n\n        this.componentClass = await AddonWorkshopAssessmentStrategyDelegate.getComponentForPlugin(this.strategy);\n        if (this.componentClass) {\n            this.overallFeedkback = this.workshop.overallfeedbackmode != AddonModWorkshopOverallFeedbackMode.DISABLED;\n            this.overallFeedkbackRequired =\n                this.workshop.overallfeedbackmode == AddonModWorkshopOverallFeedbackMode.ENABLED_REQUIRED;\n            this.componentId = this.workshop.coursemodule;\n\n            // Load Weights selector.\n            if (this.edit && this.access.canallocate) {\n                this.weights = [];\n                for (let i = 16; i >= 0; i--) {\n                    this.weights[i] = i;\n                }\n            }\n\n            // Check if rich text editor is enabled.\n            if (this.edit) {\n                // Block the workshop.\n                CoreSync.blockOperation(ADDON_MOD_WORKSHOP_COMPONENT, this.workshop.id);\n            }\n\n            try {\n                await this.load();\n                this.obsInvalidated = CoreEvents.on(\n                    AddonModWorkshopProvider.ASSESSMENT_INVALIDATED,\n                    () => this.load(),\n                    CoreSites.getCurrentSiteId(),\n                );\n            } catch (error) {\n                this.componentClass = undefined;\n                CoreDomUtils.showErrorModalDefault(error, 'Error loading assessment.');\n            } finally {\n                this.assessmentStrategyLoaded = true;\n            }\n        } else {\n            // Helper data and fallback.\n            this.notSupported = !AddonWorkshopAssessmentStrategyDelegate.isPluginSupported(this.strategy);\n            this.assessmentStrategyLoaded = true;\n        }\n    }\n\n    /**\n     * Convenience function to load the assessment data.\n     *\n     * @returns Promised resvoled when data is loaded.\n     */\n    protected async load(): Promise<void> {\n        this.data.assessment = await AddonModWorkshopHelper.getReviewerAssessmentById(this.workshop.id, this.assessmentId, {\n            userId: this.userId,\n            cmId: this.workshop.coursemodule,\n        });\n\n        if (!this.data.assessment.form) {\n            return;\n        }\n\n        if (this.edit) {\n            try {\n                const offlineAssessment = await AddonModWorkshopOffline.getAssessment(this.workshop.id, this.assessmentId);\n                const offlineData = offlineAssessment.inputdata;\n\n                this.hasOffline = true;\n\n                this.data.assessment.feedbackauthor = <string>offlineData.feedbackauthor;\n\n                if (this.access.canallocate) {\n                    this.data.assessment.weight = <number>offlineData.weight;\n                }\n\n                // Override assessment plugins values.\n                this.data.assessment.form.current = AddonModWorkshop.parseFields(\n                    CoreUtils.objectToArrayOfObjects(offlineData, 'name', 'value'),\n                );\n\n                // Override offline files.\n                if (offlineData) {\n                    this.data.assessment.feedbackattachmentfiles =\n                        await AddonModWorkshopHelper.getAssessmentFilesFromOfflineFilesObject(\n                            <CoreFileUploaderStoreFilesResult>offlineData.feedbackauthorattachmentsid,\n                            this.workshop.id,\n                            this.assessmentId,\n                        );\n                }\n            } catch {\n                this.hasOffline = false;\n                // Ignore errors.\n            } finally {\n                this.feedbackText = this.data.assessment.feedbackauthor;\n                this.feedbackControl.setValue(this.feedbackText);\n\n                this.originalData.text = this.data.assessment.feedbackauthor;\n\n                if (this.access.canallocate) {\n                    this.originalData.weight = this.data.assessment.weight;\n                }\n\n                this.originalData.files = [];\n                this.data.assessment.feedbackattachmentfiles.forEach((file) => {\n                    let filename = CoreFile.getFileName(file);\n                    if (!filename) {\n                        // We don't have filename, extract it from the path.\n                        filename = CoreFileHelper.getFilenameFromPath(file) || '';\n                    }\n\n                    this.originalData.files.push({\n                        filename,\n                        fileurl: '', // No needed to compare.\n                    });\n                });\n            }\n        }\n\n        try {\n            this.data.selectedValues = await AddonWorkshopAssessmentStrategyDelegate.getOriginalValues(\n                this.strategy,\n                this.data.assessment.form,\n                this.workshop.id,\n            );\n        } finally {\n            this.originalData.selectedValues = CoreUtils.clone(this.data.selectedValues);\n            if (this.edit) {\n                CoreFileSession.setFiles(\n                    ADDON_MOD_WORKSHOP_COMPONENT,\n                    this.workshop.id + '_' + this.assessmentId,\n                    this.data.assessment.feedbackattachmentfiles,\n                );\n                if (this.access.canallocate) {\n                    this.weight = this.data.assessment.weight;\n                }\n            }\n        }\n    }\n\n    /**\n     * Check if data has changed.\n     *\n     * @returns True if data has changed.\n     */\n    hasDataChanged(): boolean {\n        if (!this.assessmentStrategyLoaded || !this.workshop.strategy) {\n            return false;\n        }\n\n        // Compare feedback text.\n        const text = CoreTextUtils.restorePluginfileUrls(this.feedbackText, this.data.assessment?.feedbackcontentfiles || []);\n        if (this.originalData.text != text) {\n            return true;\n        }\n\n        if (this.access.canallocate && this.originalData.weight != this.weight) {\n            return true;\n        }\n\n        // Compare feedback files.\n        const files = CoreFileSession.getFiles(\n            ADDON_MOD_WORKSHOP_COMPONENT,\n            this.workshop.id + '_' + this.assessmentId,\n        ) || [];\n        if (CoreFileUploader.areFileListDifferent(files, this.originalData.files)) {\n            return true;\n        }\n\n        return AddonWorkshopAssessmentStrategyDelegate.hasDataChanged(\n            this.workshop.strategy,\n            this.originalData.selectedValues,\n            this.data.selectedValues,\n        );\n    }\n\n    /**\n     * Save the assessment.\n     *\n     * @returns Promise resolved when done, rejected if assessment could not be saved.\n     */\n    async saveAssessment(): Promise<void> {\n        if (!this.data.assessment?.form) {\n            return;\n        }\n\n        const files = CoreFileSession.getFiles(\n            ADDON_MOD_WORKSHOP_COMPONENT,\n            this.workshop.id + '_' + this.assessmentId,\n        ) || [];\n\n        let saveOffline = false;\n        let allowOffline = !files.length;\n\n        const modal = await CoreDomUtils.showModalLoading('core.sending', true);\n\n        this.data.fieldErrors = {};\n\n        try {\n            let attachmentsId: CoreFileUploaderStoreFilesResult | number;\n            try {\n                // Upload attachments first if any.\n                attachmentsId = await AddonModWorkshopHelper.uploadOrStoreAssessmentFiles(\n                    this.workshop.id,\n                    this.assessmentId,\n                    files,\n                    saveOffline,\n                );\n            } catch (error) {\n                if (CoreUtils.isWebServiceError(error)) {\n                    throw error;\n                }\n\n                // Cannot upload them in online, save them in offline.\n                saveOffline = true;\n                allowOffline = true;\n\n                attachmentsId = await AddonModWorkshopHelper.uploadOrStoreAssessmentFiles(\n                    this.workshop.id,\n                    this.assessmentId,\n                    files,\n                    saveOffline,\n                );\n            }\n\n            const text = CoreTextUtils.restorePluginfileUrls(this.feedbackText, this.data.assessment?.feedbackcontentfiles || []);\n\n            let assessmentData: CoreFormFields<unknown>;\n            try {\n                assessmentData = await AddonModWorkshopHelper.prepareAssessmentData(\n                    this.workshop,\n                    this.data.selectedValues,\n                    text,\n                    this.data.assessment.form,\n                    attachmentsId,\n                );\n            } catch (errors) {\n                this.data.fieldErrors = errors;\n\n                throw new CoreError(Translate.instant('core.errorinvalidform'));\n            }\n\n            let gradeUpdated = false;\n            if (saveOffline) {\n                // Save assessment in offline.\n                await AddonModWorkshopOffline.saveAssessment(\n                    this.workshop.id,\n                    this.assessmentId,\n                    this.workshop.course,\n                    assessmentData,\n                );\n            } else {\n\n                // Try to send it to server.\n                // Don't allow offline if there are attachments since they were uploaded fine.\n                gradeUpdated = await AddonModWorkshop.updateAssessment(\n                    this.workshop.id,\n                    this.assessmentId,\n                    this.workshop.course,\n                    assessmentData,\n                    undefined,\n                    allowOffline,\n                );\n            }\n\n            CoreForms.triggerFormSubmittedEvent(this.formElement, !!gradeUpdated, CoreSites.getCurrentSiteId());\n\n            const promises: Promise<void>[] = [];\n\n            // If sent to the server, invalidate and clean.\n            if (gradeUpdated) {\n                promises.push(AddonModWorkshopHelper.deleteAssessmentStoredFiles(this.workshop.id, this.assessmentId));\n                promises.push(AddonModWorkshop.invalidateAssessmentFormData(this.workshop.id, this.assessmentId));\n                promises.push(AddonModWorkshop.invalidateAssessmentData(this.workshop.id, this.assessmentId));\n            }\n\n            await CoreUtils.ignoreErrors(Promise.all(promises));\n\n            CoreEvents.trigger(AddonModWorkshopProvider.ASSESSMENT_SAVED, {\n                workshopId: this.workshop.id,\n                assessmentId: this.assessmentId,\n                userId: CoreSites.getCurrentSiteUserId(),\n            }, CoreSites.getCurrentSiteId());\n\n            if (files) {\n                // Delete the local files from the tmp folder.\n                CoreFileUploader.clearTmpFiles(files);\n            }\n        } catch (error) {\n            CoreDomUtils.showErrorModalDefault(error, 'Error saving assessment.');\n        } finally {\n            modal.dismiss();\n        }\n    }\n\n    /**\n     * Feedback text changed.\n     *\n     * @param text The new text.\n     */\n    onFeedbackChange(text?: string | null): void {\n        this.feedbackText = text ?? '';\n    }\n\n    /**\n     * Component destroyed.\n     */\n    ngOnDestroy(): void {\n        this.obsInvalidated?.off();\n\n        if (this.data.assessment?.feedbackattachmentfiles) {\n            // Delete the local files from the tmp folder.\n            CoreFileUploader.clearTmpFiles(this.data.assessment.feedbackattachmentfiles);\n        }\n    }\n\n}\n\ntype AddonModWorkshopAssessmentStrategyData = {\n    workshopId: number;\n    assessment?: AddonModWorkshopSubmissionAssessmentWithFormData;\n    edit: boolean;\n    selectedValues: AddonModWorkshopGetAssessmentFormFieldsParsedData[];\n    fieldErrors: AddonModWorkshopAssessmentStrategyFieldErrors;\n    strategy: string;\n    moduleId: number;\n    courseId?: number;\n};\n\nexport type AddonModWorkshopAssessmentStrategyFieldErrors = Record<string, string>;\n","<h2 class=\"ion-padding\">{{ 'addon.mod_workshop.assessmentform' | translate }}</h2>\n\n<form name=\"mma-mod_workshop-assessment-form\" #assessmentForm>\n    <core-loading [hideUntil]=\"assessmentStrategyLoaded\">\n        <ng-container *ngIf=\"componentClass && assessmentStrategyLoaded\">\n            <core-dynamic-component [component]=\"componentClass\" [data]=\"data\" />\n        </ng-container>\n\n        <ion-card class=\"core-info-card\" *ngIf=\"notSupported\">\n            <ion-item>\n                <ion-label>\n                    <p>{{ 'addon.mod_workshop.assessmentstrategynotsupported' | translate:{$a: strategy} }}</p>\n                </ion-label>\n            </ion-item>\n        </ion-card>\n\n        <ion-card *ngIf=\"assessmentStrategyLoaded && overallFeedkback &&\n            (edit || data.assessment?.feedbackauthor || data.assessment?.feedbackattachmentfiles?.length) \">\n            <ion-item class=\"ion-text-wrap\">\n                <ion-label>\n                    <h3 class=\"item-heading\">{{ 'addon.mod_workshop.overallfeedback' | translate }}</h3>\n                </ion-label>\n            </ion-item>\n            <ion-item position=\"stacked\" *ngIf=\"edit\">\n                <ion-label position=\"stacked\">\n                    <span [core-mark-required]=\"overallFeedkbackRequired\">\n                        {{ 'addon.mod_workshop.feedbackauthor' | translate }}\n                    </span>\n                </ion-label>\n                <core-rich-text-editor [control]=\"feedbackControl\" [component]=\"component\" [componentId]=\"workshop.coursemodule\"\n                    [autoSave]=\"true\" contextLevel=\"module\" [contextInstanceId]=\"workshop.coursemodule\" elementId=\"feedbackauthor_editor\"\n                    [draftExtraParams]=\"{asid: assessmentId}\" (contentChanged)=\"onFeedbackChange($event)\" />\n                <core-input-errors *ngIf=\"overallFeedkbackRequired && data.fieldErrors && data.fieldErrors['feedbackauthor']\"\n                    [errorText]=\"data.fieldErrors['feedbackauthor']\" />\n            </ion-item>\n            <core-attachments *ngIf=\"edit && workshop.overallfeedbackfiles\" [files]=\"data.assessment?.feedbackattachmentfiles\"\n                [maxSize]=\"workshop.overallfeedbackmaxbytes\" [maxSubmissions]=\"workshop.overallfeedbackfiles\" [component]=\"component\"\n                [componentId]=\"componentId\" [allowOffline]=\"true\" [courseId]=\"workshop.course\" />\n            <ion-item *ngIf=\"edit && access && access.canallocate\">\n                <ion-label position=\"stacked\">\n                    <span [core-mark-required]=\"true\">\n                        {{ 'addon.mod_workshop.assessmentweight' | translate }}\n                    </span>\n                </ion-label>\n                <ion-select [(ngModel)]=\"weight\" interface=\"action-sheet\" name=\"weight\" [cancelText]=\"'core.cancel' | translate\"\n                    [interfaceOptions]=\"{header: 'addon.mod_workshop.assessmentweight' | translate}\">\n                    <ion-select-option *ngFor=\"let w of weights\" [value]=\"w\">{{w}}</ion-select-option>\n                </ion-select>\n            </ion-item>\n            <ion-item class=\"ion-text-wrap\" *ngIf=\"!edit && data.assessment?.feedbackauthor\">\n                <ion-label>\n                    <core-format-text [component]=\"component\" [componentId]=\"componentId\" [text]=\"data.assessment?.feedbackauthor\"\n                        contextLevel=\"module\" [contextInstanceId]=\"workshop.coursemodule\" [courseId]=\"workshop.course\" />\n                </ion-label>\n            </ion-item>\n            <ion-item *ngIf=\"!edit && workshop.overallfeedbackfiles && data.assessment?.feedbackattachmentfiles?.length\">\n                <ion-label>\n                    <core-files [files]=\"data.assessment?.feedbackattachmentfiles\" [component]=\"component\" [componentId]=\"componentId\" />\n                </ion-label>\n            </ion-item>\n        </ion-card>\n    </core-loading>\n</form>\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}