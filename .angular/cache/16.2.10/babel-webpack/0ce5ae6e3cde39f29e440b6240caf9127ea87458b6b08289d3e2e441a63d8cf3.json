{"ast":null,"code":"import _asyncToGenerator from \"/home/toon/works/gitionic7/ionic-github/ionic/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nvar _class;\n// (C) Copyright 2015 Moodle Pty Ltd.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\nimport { CoreConstants } from '@/core/constants';\nimport { CoreCourseResourcePrefetchHandlerBase } from '@features/course/classes/resource-prefetch-handler';\nimport { CoreCourse } from '@features/course/services/course';\nimport { CoreFilepool } from '@services/filepool';\nimport { CoreSites } from '@services/sites';\nimport { makeSingleton } from '@singletons';\nimport { AddonModResource, AddonModResourceProvider } from '../resource';\nimport { AddonModResourceHelper } from '../resource-helper';\nimport * as i0 from \"@angular/core\";\n/**\n * Handler to prefetch resources.\n */\nexport class AddonModResourcePrefetchHandlerService extends CoreCourseResourcePrefetchHandlerBase {\n  constructor() {\n    super(...arguments);\n    this.name = 'AddonModResource';\n    this.modName = 'resource';\n    this.component = AddonModResourceProvider.COMPONENT;\n  }\n  /**\n   * @inheritdoc\n   */\n  determineStatus(module, status) {\n    if (status == CoreConstants.DOWNLOADED && module) {\n      // If the main file is an external file, always display the module as outdated.\n      if ('contentsinfo' in module && module.contentsinfo) {\n        if (module.contentsinfo.repositorytype) {\n          // It's an external file.\n          return CoreConstants.OUTDATED;\n        }\n      } else if (module.contents) {\n        const mainFile = module.contents[0];\n        if (mainFile && mainFile.isexternalfile) {\n          return CoreConstants.OUTDATED;\n        }\n      }\n    }\n    return status;\n  }\n  /**\n   * @inheritdoc\n   */\n  downloadOrPrefetch(module, courseId, prefetch) {\n    var _superprop_getDownloadOrPrefetch = () => super.downloadOrPrefetch,\n      _this = this;\n    return _asyncToGenerator(function* () {\n      let dirPath;\n      if (AddonModResourceHelper.isDisplayedInIframe(module) && module.url !== undefined) {\n        dirPath = yield CoreFilepool.getPackageDirPathByUrl(CoreSites.getCurrentSiteId(), module.url);\n      }\n      const promises = [];\n      promises.push(_superprop_getDownloadOrPrefetch().call(_this, module, courseId, prefetch, dirPath));\n      promises.push(AddonModResource.getResourceData(courseId, module.id));\n      yield Promise.all(promises);\n    })();\n  }\n  /**\n   * @inheritdoc\n   */\n  invalidateContent(moduleId, courseId) {\n    return _asyncToGenerator(function* () {\n      yield AddonModResource.invalidateContent(moduleId, courseId);\n    })();\n  }\n  /**\n   * @inheritdoc\n   */\n  invalidateModule(module, courseId) {\n    var _this2 = this;\n    return _asyncToGenerator(function* () {\n      const promises = [];\n      promises.push(AddonModResource.invalidateResourceData(courseId));\n      promises.push(CoreCourse.invalidateModule(module.id, undefined, _this2.modName));\n      yield Promise.all(promises);\n    })();\n  }\n  /**\n   * @inheritdoc\n   */\n  isDownloadable(module, courseId) {\n    var _this3 = this;\n    return _asyncToGenerator(function* () {\n      var _CoreSites$getCurrent;\n      if ((_CoreSites$getCurrent = CoreSites.getCurrentSite()) !== null && _CoreSites$getCurrent !== void 0 && _CoreSites$getCurrent.isVersionGreaterEqualThan('3.7')) {\n        // Nextcloud files are downloadable from 3.7 onwards.\n        return true;\n      }\n      // Don't allow downloading Nextcloud files in older sites.\n      yield _this3.loadContents(module, courseId, false);\n      return !AddonModResourceHelper.isNextcloudFile(module);\n    })();\n  }\n  /**\n   * @inheritdoc\n   */\n  isEnabled() {\n    return _asyncToGenerator(function* () {\n      return AddonModResource.isPluginEnabled();\n    })();\n  }\n}\n_class = AddonModResourcePrefetchHandlerService;\n_class.ɵfac = /*@__PURE__*/function () {\n  let ɵAddonModResourcePrefetchHandlerService_BaseFactory;\n  return function AddonModResourcePrefetchHandlerService_Factory(t) {\n    return (ɵAddonModResourcePrefetchHandlerService_BaseFactory || (ɵAddonModResourcePrefetchHandlerService_BaseFactory = i0.ɵɵgetInheritedFactory(_class)))(t || _class);\n  };\n}();\n_class.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n  token: _class,\n  factory: _class.ɵfac,\n  providedIn: 'root'\n});\nexport const AddonModResourcePrefetchHandler = makeSingleton(AddonModResourcePrefetchHandlerService);","map":{"version":3,"names":["CoreConstants","CoreCourseResourcePrefetchHandlerBase","CoreCourse","CoreFilepool","CoreSites","makeSingleton","AddonModResource","AddonModResourceProvider","AddonModResourceHelper","AddonModResourcePrefetchHandlerService","constructor","name","modName","component","COMPONENT","determineStatus","module","status","DOWNLOADED","contentsinfo","repositorytype","OUTDATED","contents","mainFile","isexternalfile","downloadOrPrefetch","courseId","prefetch","_superprop_getDownloadOrPrefetch","_this","_asyncToGenerator","dirPath","isDisplayedInIframe","url","undefined","getPackageDirPathByUrl","getCurrentSiteId","promises","push","call","getResourceData","id","Promise","all","invalidateContent","moduleId","invalidateModule","_this2","invalidateResourceData","isDownloadable","_this3","_CoreSites$getCurrent","getCurrentSite","isVersionGreaterEqualThan","loadContents","isNextcloudFile","isEnabled","isPluginEnabled","t","factory","ɵfac","providedIn","AddonModResourcePrefetchHandler"],"sources":["/home/toon/works/gitionic7/ionic-github/ionic/src/addons/mod/resource/services/handlers/prefetch.ts"],"sourcesContent":["// (C) Copyright 2015 Moodle Pty Ltd.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport { CoreConstants } from '@/core/constants';\nimport { Injectable } from '@angular/core';\nimport { CoreCourseResourcePrefetchHandlerBase } from '@features/course/classes/resource-prefetch-handler';\nimport { CoreCourse, CoreCourseAnyModuleData } from '@features/course/services/course';\nimport { CoreCourseModuleData } from '@features/course/services/course-helper';\nimport { CoreFilepool } from '@services/filepool';\nimport { CoreSites } from '@services/sites';\nimport { makeSingleton } from '@singletons';\nimport { AddonModResource, AddonModResourceProvider } from '../resource';\nimport { AddonModResourceHelper } from '../resource-helper';\n\n/**\n * Handler to prefetch resources.\n */\n@Injectable({ providedIn: 'root' })\nexport class AddonModResourcePrefetchHandlerService extends CoreCourseResourcePrefetchHandlerBase {\n\n    name = 'AddonModResource';\n    modName = 'resource';\n    component = AddonModResourceProvider.COMPONENT;\n\n    /**\n     * @inheritdoc\n     */\n    determineStatus(module: CoreCourseAnyModuleData, status: string): string {\n        if (status == CoreConstants.DOWNLOADED && module) {\n            // If the main file is an external file, always display the module as outdated.\n            if ('contentsinfo' in module && module.contentsinfo) {\n                if (module.contentsinfo.repositorytype) {\n                    // It's an external file.\n                    return CoreConstants.OUTDATED;\n                }\n            } else if (module.contents) {\n                const mainFile = module.contents[0];\n                if (mainFile && mainFile.isexternalfile) {\n                    return CoreConstants.OUTDATED;\n                }\n            }\n        }\n\n        return status;\n    }\n\n    /**\n     * @inheritdoc\n     */\n    async downloadOrPrefetch(module: CoreCourseModuleData, courseId: number, prefetch?: boolean): Promise<void> {\n        let dirPath: string | undefined;\n\n        if (AddonModResourceHelper.isDisplayedInIframe(module) && module.url !== undefined) {\n            dirPath = await CoreFilepool.getPackageDirPathByUrl(CoreSites.getCurrentSiteId(), module.url);\n        }\n\n        const promises: Promise<unknown>[] = [];\n\n        promises.push(super.downloadOrPrefetch(module, courseId, prefetch, dirPath));\n        promises.push(AddonModResource.getResourceData(courseId, module.id));\n\n        await Promise.all(promises);\n    }\n\n    /**\n     * @inheritdoc\n     */\n    async invalidateContent(moduleId: number, courseId: number): Promise<void> {\n        await AddonModResource.invalidateContent(moduleId, courseId);\n    }\n\n    /**\n     * @inheritdoc\n     */\n    async invalidateModule(module: CoreCourseAnyModuleData, courseId: number): Promise<void> {\n        const promises: Promise<void>[] = [];\n\n        promises.push(AddonModResource.invalidateResourceData(courseId));\n        promises.push(CoreCourse.invalidateModule(module.id, undefined, this.modName));\n\n        await Promise.all(promises);\n    }\n\n    /**\n     * @inheritdoc\n     */\n    async isDownloadable(module: CoreCourseAnyModuleData, courseId: number): Promise<boolean> {\n        if (CoreSites.getCurrentSite()?.isVersionGreaterEqualThan('3.7')) {\n            // Nextcloud files are downloadable from 3.7 onwards.\n            return true;\n        }\n\n        // Don't allow downloading Nextcloud files in older sites.\n        await this.loadContents(module, courseId, false);\n\n        return !AddonModResourceHelper.isNextcloudFile(module);\n    }\n\n    /**\n     * @inheritdoc\n     */\n    async isEnabled(): Promise<boolean> {\n        return AddonModResource.isPluginEnabled();\n    }\n\n}\nexport const AddonModResourcePrefetchHandler = makeSingleton(AddonModResourcePrefetchHandlerService);\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}