{"ast":null,"code":"import _asyncToGenerator from \"/home/toon/works/gitionic7/ionic-github/ionic/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\n// (C) Copyright 2015 Moodle Pty Ltd.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\nimport { CoreUtils } from '@services/utils/utils';\nimport { ElementController } from './ElementController';\nimport { CorePromisedValue } from '@classes/promised-value';\nimport { CoreEvents } from '@singletons/events';\nimport { CoreMedia } from '@singletons/media';\nimport { AddonFilterMediaPluginVideoJS, VIDEO_JS_PLAYER_CREATED } from '@addons/filter/mediaplugin/services/videojs';\n/**\n * Wrapper class to control the interactivity of a media element.\n */\nexport class MediaElementController extends ElementController {\n  constructor(media, enabled) {\n    super(enabled);\n    this.jsPlayer = new CorePromisedValue();\n    this.shouldEnable = false;\n    this.shouldDisable = false;\n    this.media = media;\n    this.autoplay = media.autoplay;\n    media.autoplay = false;\n    this.initJSPlayer(media);\n    enabled && this.onEnabled();\n  }\n  /**\n   * @inheritdoc\n   */\n  onEnabled() {\n    var _this = this;\n    return _asyncToGenerator(function* () {\n      var _this$playing;\n      _this.shouldEnable = true;\n      _this.shouldDisable = false;\n      const jsPlayer = yield _this.jsPlayer;\n      if (!_this.shouldEnable || _this.destroyed) {\n        return;\n      }\n      const ready = ((_this$playing = _this.playing) !== null && _this$playing !== void 0 ? _this$playing : _this.autoplay) ? (jsPlayer !== null && jsPlayer !== void 0 ? jsPlayer : _this.media).play() : Promise.resolve();\n      try {\n        yield ready;\n        _this.addPlaybackEventListeners(jsPlayer);\n      } catch (error) {\n        CoreUtils.logUnhandledError('Error enabling media element', error);\n      }\n    })();\n  }\n  /**\n   * @inheritdoc\n   */\n  onDisabled() {\n    var _this2 = this;\n    return _asyncToGenerator(function* () {\n      _this2.shouldDisable = true;\n      _this2.shouldEnable = false;\n      const jsPlayer = yield _this2.jsPlayer;\n      if (!_this2.shouldDisable || _this2.destroyed) {\n        return;\n      }\n      _this2.removePlaybackEventListeners(jsPlayer);\n      (jsPlayer !== null && jsPlayer !== void 0 ? jsPlayer : _this2.media).pause();\n    })();\n  }\n  /**\n   * @inheritdoc\n   */\n  onDestroy() {\n    var _this3 = this;\n    return _asyncToGenerator(function* () {\n      const jsPlayer = yield _this3.jsPlayer;\n      _this3.removePlaybackEventListeners(jsPlayer);\n      jsPlayer === null || jsPlayer === void 0 || jsPlayer.dispose();\n    })();\n  }\n  /**\n   * Init JS Player instance.\n   *\n   * @param media Media element.\n   */\n  initJSPlayer(media) {\n    var _this4 = this;\n    return _asyncToGenerator(function* () {\n      if (!CoreMedia.mediaUsesJavascriptPlayer(media)) {\n        _this4.jsPlayer.resolve(null);\n        return;\n      }\n      const player = yield _this4.searchJSPlayer();\n      if (!player) {\n        _this4.jsPlayerListener = CoreEvents.on(VIDEO_JS_PLAYER_CREATED, ({\n          element,\n          player\n        }) => {\n          var _this4$jsPlayerListen;\n          if (element !== media) {\n            return;\n          }\n          (_this4$jsPlayerListen = _this4.jsPlayerListener) === null || _this4$jsPlayerListen === void 0 || _this4$jsPlayerListen.off();\n          _this4.jsPlayer.resolve(player);\n        });\n        return;\n      }\n      _this4.jsPlayer.resolve(player);\n    })();\n  }\n  /**\n   * Start listening playback events.\n   *\n   * @param jsPlayer Javascript player instance (if any).\n   */\n  addPlaybackEventListeners(jsPlayer) {\n    if (jsPlayer) {\n      jsPlayer.on('play', this.playListener = () => this.playing = true);\n      jsPlayer.on('pause', this.pauseListener = () => this.playing = false);\n    } else {\n      this.media.addEventListener('play', this.playListener = () => this.playing = true);\n      this.media.addEventListener('pause', this.pauseListener = () => this.playing = false);\n    }\n  }\n  /**\n   * Stop listening playback events.\n   *\n   * @param jsPlayer Javascript player instance (if any).\n   */\n  removePlaybackEventListeners(jsPlayer) {\n    if (jsPlayer) {\n      this.playListener && jsPlayer.off('play', this.playListener);\n      this.pauseListener && jsPlayer.off('pause', this.pauseListener);\n    } else {\n      this.playListener && this.media.removeEventListener('play', this.playListener);\n      this.pauseListener && this.media.removeEventListener('pause', this.pauseListener);\n    }\n    delete this.playListener;\n    delete this.pauseListener;\n  }\n  /**\n   * Search JS player instance.\n   *\n   * @returns Player instance if found.\n   */\n  searchJSPlayer() {\n    var _this5 = this;\n    return _asyncToGenerator(function* () {\n      var _AddonFilterMediaPlug;\n      return (_AddonFilterMediaPlug = AddonFilterMediaPluginVideoJS.findPlayer(_this5.media.id)) !== null && _AddonFilterMediaPlug !== void 0 ? _AddonFilterMediaPlug : AddonFilterMediaPluginVideoJS.findPlayer(_this5.media.id.replace('_html5_api', ''));\n    })();\n  }\n}","map":{"version":3,"names":["CoreUtils","ElementController","CorePromisedValue","CoreEvents","CoreMedia","AddonFilterMediaPluginVideoJS","VIDEO_JS_PLAYER_CREATED","MediaElementController","constructor","media","enabled","jsPlayer","shouldEnable","shouldDisable","autoplay","initJSPlayer","onEnabled","_this","_asyncToGenerator","_this$playing","destroyed","ready","playing","play","Promise","resolve","addPlaybackEventListeners","error","logUnhandledError","onDisabled","_this2","removePlaybackEventListeners","pause","onDestroy","_this3","dispose","_this4","mediaUsesJavascriptPlayer","player","searchJSPlayer","jsPlayerListener","on","element","_this4$jsPlayerListen","off","playListener","pauseListener","addEventListener","removeEventListener","_this5","_AddonFilterMediaPlug","findPlayer","id","replace"],"sources":["/home/toon/works/gitionic7/ionic-github/ionic/src/core/classes/element-controllers/MediaElementController.ts"],"sourcesContent":["// (C) Copyright 2015 Moodle Pty Ltd.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport { CoreUtils } from '@services/utils/utils';\nimport { ElementController } from './ElementController';\nimport { CorePromisedValue } from '@classes/promised-value';\nimport { CoreEventObserver, CoreEvents } from '@singletons/events';\nimport { CoreMedia } from '@singletons/media';\nimport { AddonFilterMediaPluginVideoJS, VIDEO_JS_PLAYER_CREATED } from '@addons/filter/mediaplugin/services/videojs';\nimport type { VideoJSPlayer } from 'video.js';\n\n/**\n * Wrapper class to control the interactivity of a media element.\n */\nexport class MediaElementController extends ElementController {\n\n    private media: HTMLMediaElement;\n    private autoplay: boolean;\n    private playing?: boolean;\n    private playListener?: () => void;\n    private pauseListener?: () => void;\n    private jsPlayer = new CorePromisedValue<VideoJSPlayer | null>();\n    private jsPlayerListener?: CoreEventObserver;\n    private shouldEnable = false;\n    private shouldDisable = false;\n\n    constructor(media: HTMLMediaElement, enabled: boolean) {\n        super(enabled);\n\n        this.media = media;\n        this.autoplay = media.autoplay;\n\n        media.autoplay = false;\n\n        this.initJSPlayer(media);\n\n        enabled && this.onEnabled();\n    }\n\n    /**\n     * @inheritdoc\n     */\n    async onEnabled(): Promise<void> {\n        this.shouldEnable = true;\n        this.shouldDisable = false;\n\n        const jsPlayer = await this.jsPlayer;\n\n        if (!this.shouldEnable || this.destroyed) {\n            return;\n        }\n\n        const ready = this.playing ?? this.autoplay\n            ? (jsPlayer ?? this.media).play()\n            : Promise.resolve();\n\n        try {\n            await ready;\n\n            this.addPlaybackEventListeners(jsPlayer);\n        } catch (error) {\n            CoreUtils.logUnhandledError('Error enabling media element', error);\n        }\n    }\n\n    /**\n     * @inheritdoc\n     */\n    async onDisabled(): Promise<void> {\n        this.shouldDisable = true;\n        this.shouldEnable = false;\n\n        const jsPlayer = await this.jsPlayer;\n\n        if (!this.shouldDisable || this.destroyed) {\n            return;\n        }\n\n        this.removePlaybackEventListeners(jsPlayer);\n\n        (jsPlayer ?? this.media).pause();\n    }\n\n    /**\n     * @inheritdoc\n     */\n    async onDestroy(): Promise<void> {\n        const jsPlayer = await this.jsPlayer;\n\n        this.removePlaybackEventListeners(jsPlayer);\n        jsPlayer?.dispose();\n    }\n\n    /**\n     * Init JS Player instance.\n     *\n     * @param media Media element.\n     */\n    private async initJSPlayer(media: HTMLMediaElement): Promise<void> {\n        if (!CoreMedia.mediaUsesJavascriptPlayer(media)) {\n            this.jsPlayer.resolve(null);\n\n            return;\n        }\n\n        const player = await this.searchJSPlayer();\n\n        if (!player) {\n            this.jsPlayerListener = CoreEvents.on(VIDEO_JS_PLAYER_CREATED, ({ element, player }) => {\n                if (element !== media) {\n                    return;\n                }\n\n                this.jsPlayerListener?.off();\n                this.jsPlayer.resolve(player);\n            });\n\n            return;\n        }\n\n        this.jsPlayer.resolve(player);\n    }\n\n    /**\n     * Start listening playback events.\n     *\n     * @param jsPlayer Javascript player instance (if any).\n     */\n    private addPlaybackEventListeners(jsPlayer: VideoJSPlayer | null): void {\n        if (jsPlayer) {\n            jsPlayer.on('play', this.playListener = () => this.playing = true);\n            jsPlayer.on('pause', this.pauseListener = () => this.playing = false);\n        } else {\n            this.media.addEventListener('play', this.playListener = () => this.playing = true);\n            this.media.addEventListener('pause', this.pauseListener = () => this.playing = false);\n        }\n    }\n\n    /**\n     * Stop listening playback events.\n     *\n     * @param jsPlayer Javascript player instance (if any).\n     */\n    private removePlaybackEventListeners(jsPlayer: VideoJSPlayer | null): void {\n        if (jsPlayer) {\n            this.playListener && jsPlayer.off('play', this.playListener);\n            this.pauseListener && jsPlayer.off('pause', this.pauseListener);\n        } else {\n            this.playListener && this.media.removeEventListener('play', this.playListener);\n            this.pauseListener && this.media.removeEventListener('pause', this.pauseListener);\n        }\n\n        delete this.playListener;\n        delete this.pauseListener;\n    }\n\n    /**\n     * Search JS player instance.\n     *\n     * @returns Player instance if found.\n     */\n    private async searchJSPlayer(): Promise<VideoJSPlayer | null> {\n        return AddonFilterMediaPluginVideoJS.findPlayer(this.media.id)\n            ?? AddonFilterMediaPluginVideoJS.findPlayer(this.media.id.replace('_html5_api', ''));\n    }\n\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}