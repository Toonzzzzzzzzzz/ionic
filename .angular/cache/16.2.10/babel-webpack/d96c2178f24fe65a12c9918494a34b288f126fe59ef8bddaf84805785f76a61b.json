{"ast":null,"code":"import _asyncToGenerator from \"/home/toon/works/gitionic7/ionic-github/ionic/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nvar _class;\nimport { CorePromisedValue } from '@classes/promised-value';\nimport { CoreExternalContentDirective } from '@directives/external-content';\nimport { CoreLang } from '@services/lang';\nimport { CoreTextUtils } from '@services/utils/text';\nimport { CoreUrlUtils } from '@services/utils/url';\nimport { makeSingleton } from '@singletons';\nimport { CoreDirectivesRegistry } from '@singletons/directives-registry';\nimport { CoreEvents } from '@singletons/events';\nimport * as i0 from \"@angular/core\";\nexport const VIDEO_JS_PLAYER_CREATED = 'video_js_player_created';\n/**\n * Wrapper encapsulating videojs functionality.\n */\nexport class AddonFilterMediaPluginVideoJSService {\n  /**\n   * Create a VideoJS player.\n   *\n   * @param element Media element.\n   */\n  createPlayer(element) {\n    var _this = this;\n    return _asyncToGenerator(function* () {\n      // Wait for external-content to finish in the element and its sources.\n      yield Promise.all([CoreDirectivesRegistry.waitDirectivesReady(element, undefined, CoreExternalContentDirective), CoreDirectivesRegistry.waitDirectivesReady(element, 'source', CoreExternalContentDirective)]);\n      // Create player.\n      const videojs = yield _this.getVideoJS();\n      const dataSetupString = element.getAttribute('data-setup') || element.getAttribute('data-setup-lazy') || '{}';\n      const data = CoreTextUtils.parseJSON(dataSetupString, {});\n      const player = videojs(element, {\n        controls: true,\n        techOrder: ['OgvJS'],\n        language: yield CoreLang.getCurrentLanguage(),\n        controlBar: {\n          pictureInPictureToggle: false\n        },\n        aspectRatio: data.aspectRatio\n      }, () => element.tagName === 'VIDEO' && _this.fixVideoJSPlayerSize(player));\n      CoreEvents.trigger(VIDEO_JS_PLAYER_CREATED, {\n        element,\n        player\n      });\n    })();\n  }\n  /**\n   * Find a VideoJS player by id.\n   *\n   * @param id Element id.\n   * @returns VideoJS player.\n   */\n  findPlayer(id) {\n    var _this2 = this;\n    return _asyncToGenerator(function* () {\n      const videojs = yield _this2.getVideoJS();\n      return videojs.getPlayer(id);\n    })();\n  }\n  /**\n   * Treat Video JS Youtube video links and translate them to iframes.\n   *\n   * @param video Video element.\n   */\n  treatYoutubeVideos(video) {\n    var _data$techOrder, _data$sources, _video$parentNode;\n    if (!video.classList.contains('video-js')) {\n      return;\n    }\n    const dataSetupString = video.getAttribute('data-setup') || video.getAttribute('data-setup-lazy') || '{}';\n    const data = CoreTextUtils.parseJSON(dataSetupString, {});\n    const youtubeUrl = ((_data$techOrder = data.techOrder) === null || _data$techOrder === void 0 ? void 0 : _data$techOrder[0]) == 'youtube' && CoreUrlUtils.getYoutubeEmbedUrl((_data$sources = data.sources) === null || _data$sources === void 0 || (_data$sources = _data$sources[0]) === null || _data$sources === void 0 ? void 0 : _data$sources.src);\n    if (!youtubeUrl) {\n      return;\n    }\n    const iframe = document.createElement('iframe');\n    iframe.id = video.id;\n    iframe.src = youtubeUrl;\n    iframe.setAttribute('frameborder', '0');\n    iframe.setAttribute('allowfullscreen', '1');\n    iframe.width = '100%';\n    iframe.height = '300';\n    // Replace video tag by the iframe.\n    (_video$parentNode = video.parentNode) === null || _video$parentNode === void 0 || _video$parentNode.replaceChild(iframe, video);\n  }\n  /**\n   * Gets videojs instance.\n   *\n   * @returns VideoJS.\n   */\n  getVideoJS() {\n    var _this3 = this;\n    return _asyncToGenerator(function* () {\n      if (!_this3.videojs) {\n        _this3.videojs = new CorePromisedValue();\n        // Inject CSS.\n        const link = document.createElement('link');\n        link.rel = 'stylesheet';\n        link.href = 'assets/lib/video.js/video-js.min.css';\n        document.head.appendChild(link);\n        // Load library.\n        return import('@addons/filter/mediaplugin/utils/videojs').then(({\n          initializeVideoJSOgvJS,\n          videojs\n        }) => {\n          var _this3$videojs;\n          initializeVideoJSOgvJS();\n          (_this3$videojs = _this3.videojs) === null || _this3$videojs === void 0 || _this3$videojs.resolve(videojs);\n          return videojs;\n        });\n      }\n      return _this3.videojs;\n    })();\n  }\n  /**\n   * Fix VideoJS player size.\n   * If video width is wider than available width, video is cut off. Fix the dimensions in this case.\n   *\n   * @param player Player instance.\n   */\n  fixVideoJSPlayerSize(player) {\n    const videoWidth = player.videoWidth();\n    const videoHeight = player.videoHeight();\n    const playerDimensions = player.currentDimensions();\n    if (!videoWidth || !videoHeight || !playerDimensions.width || videoWidth === playerDimensions.width) {\n      return;\n    }\n    const candidateHeight = playerDimensions.width * videoHeight / videoWidth;\n    if (!playerDimensions.height || Math.abs(candidateHeight - playerDimensions.height) > 1) {\n      player.dimension('height', candidateHeight);\n    }\n  }\n}\n_class = AddonFilterMediaPluginVideoJSService;\n_class.ɵfac = function AddonFilterMediaPluginVideoJSService_Factory(t) {\n  return new (t || _class)();\n};\n_class.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n  token: _class,\n  factory: _class.ɵfac,\n  providedIn: 'root'\n});\nexport const AddonFilterMediaPluginVideoJS = makeSingleton(AddonFilterMediaPluginVideoJSService);","map":{"version":3,"names":["CorePromisedValue","CoreExternalContentDirective","CoreLang","CoreTextUtils","CoreUrlUtils","makeSingleton","CoreDirectivesRegistry","CoreEvents","VIDEO_JS_PLAYER_CREATED","AddonFilterMediaPluginVideoJSService","createPlayer","element","_this","_asyncToGenerator","Promise","all","waitDirectivesReady","undefined","videojs","getVideoJS","dataSetupString","getAttribute","data","parseJSON","player","controls","techOrder","language","getCurrentLanguage","controlBar","pictureInPictureToggle","aspectRatio","tagName","fixVideoJSPlayerSize","trigger","findPlayer","id","_this2","getPlayer","treatYoutubeVideos","video","_data$techOrder","_data$sources","_video$parentNode","classList","contains","youtubeUrl","getYoutubeEmbedUrl","sources","src","iframe","document","createElement","setAttribute","width","height","parentNode","replaceChild","_this3","link","rel","href","head","appendChild","then","initializeVideoJSOgvJS","_this3$videojs","resolve","videoWidth","videoHeight","playerDimensions","currentDimensions","candidateHeight","Math","abs","dimension","factory","ɵfac","providedIn","AddonFilterMediaPluginVideoJS"],"sources":["/home/toon/works/gitionic7/ionic-github/ionic/src/addons/filter/mediaplugin/services/videojs.ts"],"sourcesContent":["// (C) Copyright 2015 Moodle Pty Ltd.\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport { Injectable } from '@angular/core';\nimport { CorePromisedValue } from '@classes/promised-value';\nimport { CoreExternalContentDirective } from '@directives/external-content';\nimport { CoreLang } from '@services/lang';\nimport { CoreTextUtils } from '@services/utils/text';\nimport { CoreUrlUtils } from '@services/utils/url';\nimport { makeSingleton } from '@singletons';\nimport { CoreDirectivesRegistry } from '@singletons/directives-registry';\nimport { CoreEvents } from '@singletons/events';\nimport type videojs from 'video.js';\n\n// eslint-disable-next-line no-duplicate-imports\nimport type { VideoJSOptions, VideoJSPlayer } from 'video.js';\n\ndeclare module '@singletons/events' {\n\n    /**\n     * Augment CoreEventsData interface with events specific to this service.\n     *\n     * @see https://www.typescriptlang.org/docs/handbook/declaration-merging.html#module-augmentation\n     */\n    export interface CoreEventsData {\n        [VIDEO_JS_PLAYER_CREATED]: CoreEventJSVideoPlayerCreated;\n    }\n\n}\n\nexport const VIDEO_JS_PLAYER_CREATED = 'video_js_player_created';\n\n/**\n * Wrapper encapsulating videojs functionality.\n */\n@Injectable({ providedIn: 'root' })\nexport class AddonFilterMediaPluginVideoJSService {\n\n    protected videojs?: CorePromisedValue<typeof videojs>;\n\n    /**\n     * Create a VideoJS player.\n     *\n     * @param element Media element.\n     */\n    async createPlayer(element: HTMLVideoElement | HTMLAudioElement): Promise<void> {\n        // Wait for external-content to finish in the element and its sources.\n        await Promise.all([\n            CoreDirectivesRegistry.waitDirectivesReady(element, undefined, CoreExternalContentDirective),\n            CoreDirectivesRegistry.waitDirectivesReady(element, 'source', CoreExternalContentDirective),\n        ]);\n\n        // Create player.\n        const videojs = await this.getVideoJS();\n        const dataSetupString = element.getAttribute('data-setup') || element.getAttribute('data-setup-lazy') || '{}';\n        const data = CoreTextUtils.parseJSON<VideoJSOptions>(dataSetupString, {});\n        const player = videojs(\n            element,\n            {\n                controls: true,\n                techOrder: ['OgvJS'],\n                language: await CoreLang.getCurrentLanguage(),\n                controlBar: { pictureInPictureToggle: false },\n                aspectRatio: data.aspectRatio,\n            },\n            () => element.tagName === 'VIDEO' && this.fixVideoJSPlayerSize(player),\n        );\n\n        CoreEvents.trigger(VIDEO_JS_PLAYER_CREATED, {\n            element,\n            player,\n        });\n    }\n\n    /**\n     * Find a VideoJS player by id.\n     *\n     * @param id Element id.\n     * @returns VideoJS player.\n     */\n    async findPlayer(id: string): Promise<VideoJSPlayer | null> {\n        const videojs = await this.getVideoJS();\n\n        return videojs.getPlayer(id);\n    }\n\n    /**\n     * Treat Video JS Youtube video links and translate them to iframes.\n     *\n     * @param video Video element.\n     */\n    treatYoutubeVideos(video: HTMLElement): void {\n        if (!video.classList.contains('video-js')) {\n            return;\n        }\n\n        const dataSetupString = video.getAttribute('data-setup') || video.getAttribute('data-setup-lazy') || '{}';\n        const data = CoreTextUtils.parseJSON<VideoJSOptions>(dataSetupString, {});\n        const youtubeUrl = data.techOrder?.[0] == 'youtube' && CoreUrlUtils.getYoutubeEmbedUrl(data.sources?.[0]?.src);\n\n        if (!youtubeUrl) {\n            return;\n        }\n\n        const iframe = document.createElement('iframe');\n        iframe.id = video.id;\n        iframe.src = youtubeUrl;\n        iframe.setAttribute('frameborder', '0');\n        iframe.setAttribute('allowfullscreen', '1');\n        iframe.width = '100%';\n        iframe.height = '300';\n\n        // Replace video tag by the iframe.\n        video.parentNode?.replaceChild(iframe, video);\n    }\n\n    /**\n     * Gets videojs instance.\n     *\n     * @returns VideoJS.\n     */\n    protected async getVideoJS(): Promise<typeof videojs> {\n        if (!this.videojs) {\n            this.videojs = new CorePromisedValue();\n\n            // Inject CSS.\n            const link = document.createElement('link');\n\n            link.rel = 'stylesheet';\n            link.href = 'assets/lib/video.js/video-js.min.css';\n\n            document.head.appendChild(link);\n\n            // Load library.\n            return import('@addons/filter/mediaplugin/utils/videojs').then(({ initializeVideoJSOgvJS, videojs }) => {\n                initializeVideoJSOgvJS();\n\n                this.videojs?.resolve(videojs);\n\n                return videojs;\n            });\n        }\n\n        return this.videojs;\n    }\n\n    /**\n     * Fix VideoJS player size.\n     * If video width is wider than available width, video is cut off. Fix the dimensions in this case.\n     *\n     * @param player Player instance.\n     */\n    protected fixVideoJSPlayerSize(player: VideoJSPlayer): void {\n        const videoWidth = player.videoWidth();\n        const videoHeight = player.videoHeight();\n        const playerDimensions = player.currentDimensions();\n        if (!videoWidth || !videoHeight || !playerDimensions.width || videoWidth === playerDimensions.width) {\n            return;\n        }\n\n        const candidateHeight = playerDimensions.width * videoHeight / videoWidth;\n        if (!playerDimensions.height || Math.abs(candidateHeight - playerDimensions.height) > 1) {\n            player.dimension('height', candidateHeight);\n        }\n    }\n\n}\n\nexport const AddonFilterMediaPluginVideoJS = makeSingleton(AddonFilterMediaPluginVideoJSService);\n\n/**\n * Data passed to VIDEO_JS_PLAYER_CREATED event.\n */\nexport type CoreEventJSVideoPlayerCreated = {\n    element: HTMLAudioElement | HTMLVideoElement;\n    player: VideoJSPlayer;\n};\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}